<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Semantic Search App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    input[type="text"], input[type="url"] { width: 100%; padding: 10px; margin: 10px 0; }
    button { padding: 10px 12px; background: #2b6cb0; color: #fff; border: none; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .results { margin-top: 20px; }
    .item { border-bottom: 1px solid #ddd; padding: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Semantic Search</h1>

    <!-- Configuration -->
    <label for="backendUrl">Backend Search API URL</label>
    <input type="url" id="backendUrl" placeholder="https://your-service.example.com/api/semantic-search" />
    <button id="saveBtn" onclick="saveConfig()" disabled>Save Configuration</button>

    <!-- Search -->
    <div style="margin-top: 20px;">
      <input type="text" id="searchInput" placeholder="Enter search query..." />
      <button id="searchBtn" onclick="search()" disabled>Search</button>
    </div>

    <div id="results" class="results"></div>
  </div>

  <!-- App SDK for in-Contentstack usage -->
  <script src="https://unpkg.com/@contentstack/app-sdk@2.1.0/dist/index.js"></script>
  <script>
    let appSdk = null;
    const saveBtn = document.getElementById('saveBtn');
    const searchBtn = document.getElementById('searchBtn');
    const backendUrlEl = document.getElementById('backendUrl');
    const resultsEl = document.getElementById('results');

    // Try to initialize App SDK (works when embedded in Contentstack UI Locations)
    (async () => {
      try {
        if (window.ContentstackAppSdk && typeof ContentstackAppSdk.init === 'function') {
          appSdk = await ContentstackAppSdk.init();
          const cfg = await appSdk.getConfig();
          if (cfg?.backendUrl) backendUrlEl.value = cfg.backendUrl;
        } else {
          // Fallback for direct (non-Contentstack) testing
          const stored = localStorage.getItem('backendUrl');
          if (stored) backendUrlEl.value = stored;
        }
      } catch (e) {
        console.warn('App SDK init failed, using fallback store', e);
        const stored = localStorage.getItem('backendUrl');
        if (stored) backendUrlEl.value = stored;
      } finally {
        saveBtn.disabled = false;
        searchBtn.disabled = false;
      }
    })();

    async function saveConfig() {
      const url = backendUrlEl.value.trim();
      if (!url) { alert('Enter a backend URL'); return; }

      // Save via App SDK when available; otherwise use localStorage for dev
      if (appSdk) {
        await appSdk.setConfig({ backendUrl: url });
        alert('Configuration saved to Contentstack App Config');
      } else {
        localStorage.setItem('backendUrl', url);
        alert('Configuration saved locally (dev fallback)');
      }
    }

    async function getBackendUrl() {
      if (appSdk) {
        const cfg = await appSdk.getConfig();
        return cfg?.backendUrl || '';
      }
      return localStorage.getItem('backendUrl') || '';
    }

    async function search() {
      resultsEl.innerHTML = '';
      const q = document.getElementById('searchInput').value.trim();
      if (!q) { resultsEl.innerHTML = '<p>Please enter a query.</p>'; return; }

      const url = await getBackendUrl();
      if (!url) { resultsEl.innerHTML = '<p>Please set the backend URL above.</p>'; return; }

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q, limit: 10 })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.results || data.results.length === 0) {
          resultsEl.innerHTML = '<p>No results found.</p>';
          return;
        }
        resultsEl.innerHTML = data.results.map(r => `
          <div class="item">
            <h3>${r.title ?? ''}</h3>
            <p>${r.summary ?? ''}</p>
            <small>${r.updated_at ?? ''}</small>
          </div>
        `).join('');
      } catch (err) {
        resultsEl.innerHTML = `<p>Error: ${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
